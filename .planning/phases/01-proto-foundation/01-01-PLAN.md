---
phase: 01-proto-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proto/buf.yaml
  - proto/buf.gen.yaml
  - proto/buf.lock
  - proto/worldmonitor/core/v1/geo.proto
  - proto/worldmonitor/core/v1/time.proto
  - proto/worldmonitor/core/v1/pagination.proto
  - proto/worldmonitor/core/v1/i18n.proto
  - proto/worldmonitor/core/v1/identifiers.proto
  - proto/worldmonitor/core/v1/general_error.proto
autonomous: true
requirements:
  - PROTO-01
  - PROTO-02
  - PROTO-03

must_haves:
  truths:
    - "buf lint passes with zero errors on all core proto files"
    - "Shared proto messages (GeoCoordinates, TimeRange, PaginationRequest/Response, LocalizableString, GeneralError, typed IDs) exist and are importable"
    - "Proto directory follows worldmonitor/{domain}/v1/ pattern with core/v1/ for shared types"
    - "buf.yaml has STANDARD + COMMENTS lint rules and FILE + PACKAGE + WIRE_JSON breaking change detection"
  artifacts:
    - path: "proto/buf.yaml"
      provides: "Buf module configuration with lint rules, breaking change detection, and sebuf/protovalidate dependencies"
      contains: "buf.build/sebmelki/sebuf"
    - path: "proto/buf.gen.yaml"
      provides: "Code generation plugin configuration for ts-client, ts-server, and openapiv3"
      contains: "protoc-gen-ts-client"
    - path: "proto/worldmonitor/core/v1/geo.proto"
      provides: "GeoCoordinates message with lat/lng validation"
      contains: "message GeoCoordinates"
    - path: "proto/worldmonitor/core/v1/time.proto"
      provides: "TimeRange message"
      contains: "message TimeRange"
    - path: "proto/worldmonitor/core/v1/pagination.proto"
      provides: "PaginationRequest and PaginationResponse messages"
      contains: "message PaginationRequest"
    - path: "proto/worldmonitor/core/v1/i18n.proto"
      provides: "LocalizableString message for multilingual content"
      contains: "message LocalizableString"
    - path: "proto/worldmonitor/core/v1/identifiers.proto"
      provides: "Typed ID wrappers for cross-domain references (HotspotID, etc.)"
      contains: "message HotspotID"
    - path: "proto/worldmonitor/core/v1/general_error.proto"
      provides: "GeneralError with oneof subtypes for app-wide error conditions"
      contains: "message GeneralError"
  key_links:
    - from: "proto/buf.yaml"
      to: "buf.build/sebmelki/sebuf"
      via: "BSR dependency"
      pattern: "buf\\.build/sebmelki/sebuf"
    - from: "proto/worldmonitor/core/v1/*.proto"
      to: "proto/buf.yaml"
      via: "module root resolution"
      pattern: "package worldmonitor\\.core\\.v1"
---

<objective>
Configure the Buf toolchain and create all shared core proto types that every subsequent domain service will import.

Purpose: Establishes the proto module root, lint/breaking rules, code generation plugin config, and the complete set of shared utility types (geo, time, pagination, i18n, identifiers, general errors) that form the foundation for all domain protos.

Output: Working `buf lint`-passing proto module with 6 core type files and complete buf.yaml/buf.gen.yaml configuration.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-proto-foundation/01-CONTEXT.md
@.planning/phases/01-proto-foundation/01-RESEARCH.md

Reference project for patterns:
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/buf.yaml
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/anghamna/core/v1/general_error.proto
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/anghamna/core/v1/identifiers.proto
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/anghamna/core/v1/i18n.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create buf.yaml and buf.gen.yaml configuration</name>
  <files>
    proto/buf.yaml
    proto/buf.gen.yaml
  </files>
  <action>
Create the `proto/` directory as the buf module root.

**proto/buf.yaml** -- Match anghamna pattern exactly:
```yaml
version: v2
deps:
  - buf.build/bufbuild/protovalidate
  - buf.build/sebmelki/sebuf
lint:
  use:
    - STANDARD
    - COMMENTS
  enum_zero_value_suffix: _UNSPECIFIED
  service_suffix: Service
breaking:
  use:
    - FILE
    - PACKAGE
    - WIRE_JSON
```

**proto/buf.gen.yaml** -- WorldMonitor-specific (TypeScript + OpenAPI only, no Go/Swift/Java):
```yaml
version: v2
plugins:
  - local: protoc-gen-ts-client
    out: ../src/generated/client

  - local: protoc-gen-ts-server
    out: ../src/generated/server

  - local: protoc-gen-openapiv3
    out: ../docs/api

  - local: protoc-gen-openapiv3
    out: ../docs/api
    opt:
      - format=json
```

Note: OpenAPI output goes to `docs/api/` (not root `docs/`) to avoid mixing with existing documentation files in `docs/`.

After creating the files, run `cd proto && buf dep update` to generate `buf.lock` with resolved dependency versions.

**Important:** Verify `protoc-gen-ts-client` and `protoc-gen-openapiv3` are available at `/Users/sebastienmelki/go/bin/`. If `protoc-gen-ts-server` is NOT installed, install it:
```bash
GOPROXY=direct GOPRIVATE=github.com/SebastienMelki go install github.com/SebastienMelki/sebuf/cmd/protoc-gen-ts-server@v0.6.0
```
  </action>
  <verify>
Run:
1. `ls proto/buf.yaml proto/buf.gen.yaml proto/buf.lock` -- all three files exist
2. `cd proto && buf dep update` completes without errors
3. Verify `which protoc-gen-ts-client && which protoc-gen-ts-server && which protoc-gen-openapiv3` -- all three plugins found
  </verify>
  <done>
buf.yaml has v2 format with STANDARD+COMMENTS lint, FILE+PACKAGE+WIRE_JSON breaking, deps on protovalidate and sebuf. buf.gen.yaml configures ts-client, ts-server, and openapiv3 (JSON+YAML) plugins. buf.lock exists with resolved versions. All three protoc plugins are available on PATH.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared core proto type definitions</name>
  <files>
    proto/worldmonitor/core/v1/geo.proto
    proto/worldmonitor/core/v1/time.proto
    proto/worldmonitor/core/v1/pagination.proto
    proto/worldmonitor/core/v1/i18n.proto
    proto/worldmonitor/core/v1/identifiers.proto
    proto/worldmonitor/core/v1/general_error.proto
  </files>
  <action>
Create the directory `proto/worldmonitor/core/v1/` and populate it with 6 proto files. All files use `syntax = "proto3"` and `package worldmonitor.core.v1`. Every message, field, enum, and enum value MUST have a doc comment (COMMENTS lint rule). Use `buf/validate/validate.proto` for field validation annotations.

**geo.proto** -- Geographic coordinates:
- `GeoCoordinates` message with `latitude` (double, -90 to 90) and `longitude` (double, -180 to 180) fields with `buf.validate` range constraints.
- `BoundingBox` message with `north_east` and `south_west` GeoCoordinates fields for geographic area queries.

**time.proto** -- Time utilities:
- `TimeRange` message with `start` (google.protobuf.Timestamp) and `end` (google.protobuf.Timestamp) fields.
- Import `google/protobuf/timestamp.proto`.

**pagination.proto** -- Cursor-based pagination:
- `PaginationRequest` message with `page_size` (int32, gte=1, lte=100) and `cursor` (string) fields.
- `PaginationResponse` message with `next_cursor` (string) and `total_count` (int32) fields.

**i18n.proto** -- Internationalization:
- `LocalizableString` message with `value` (string, required) and `language` (string, e.g., "en", "ar") fields. Keep simple -- this is for API response strings that may have locale context, not a full translation system like anghamna's MultilingualString. WorldMonitor receives pre-localized strings from upstream APIs.

**identifiers.proto** -- Typed cross-domain ID wrappers:
- Follow anghamna pattern exactly: each ID is a message with a single `value` string field with required, min_len=1, max_len=100, and example annotations.
- Define: `HotspotID` (geographic hotspot reference), `EventID` (cross-domain event reference), `ProviderID` (upstream data provider reference).
- These are the cross-domain reference IDs needed initially. More can be added in later phases as domain boundaries are established.

**general_error.proto** -- App-wide error conditions:
- `GeneralError` message with oneof `error_type` containing:
  - `RateLimited` (with `retry_after_seconds` int32 and `provider` string)
  - `UpstreamDown` (with `provider` string and `message` string)
  - `GeoBlocked` (with `reason` string)
  - `MaintenanceMode` (with `estimated_end` google.protobuf.Timestamp)
- Import timestamp for MaintenanceMode.
- Follow anghamna's general_error.proto pattern: each error subtype is a separate message with its own fields and doc comments.

**Key rules from CONTEXT.md (locked decisions):**
- Utility types ONLY in core -- no domain-specific types here
- Domain-internal IDs stay as plain string fields -- these typed wrappers are for cross-domain references only
- Severity enums are domain-specific -- do NOT add any shared severity enum
  </action>
  <verify>
Run:
1. `cd proto && buf lint` -- zero errors, zero warnings
2. `cd proto && buf build` -- builds successfully
3. Verify all 6 files exist: `ls proto/worldmonitor/core/v1/*.proto | wc -l` returns 6
4. Verify package declarations match directory: `grep -r "package worldmonitor.core.v1" proto/worldmonitor/core/v1/` shows all files
  </verify>
  <done>
Six core proto files exist at `proto/worldmonitor/core/v1/` with properly commented messages: GeoCoordinates + BoundingBox (geo), TimeRange (time), PaginationRequest + PaginationResponse (pagination), LocalizableString (i18n), HotspotID + EventID + ProviderID (identifiers), GeneralError with RateLimited/UpstreamDown/GeoBlocked/MaintenanceMode subtypes (general_error). `buf lint` passes with zero errors. `buf build` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd proto && buf lint` passes with zero errors (STANDARD + COMMENTS rules)
2. `cd proto && buf build` succeeds
3. All 6 core proto files exist at `proto/worldmonitor/core/v1/`
4. `proto/buf.yaml` has correct deps, lint rules, and breaking rules
5. `proto/buf.gen.yaml` configures ts-client, ts-server, and openapiv3 plugins
6. `proto/buf.lock` exists with resolved dependency versions
7. Directory structure is `proto/worldmonitor/core/v1/` (not `proto/models/` or `proto/services/`)
</verification>

<success_criteria>
- `buf lint` passes cleanly on all proto files
- `buf build` succeeds (proto files compile)
- Shared types are defined and ready for import by domain protos
- Buf toolchain is fully configured for subsequent `buf generate`
</success_criteria>

<output>
After completion, create `.planning/phases/01-proto-foundation/01-01-SUMMARY.md`
</output>
