---
phase: 01-proto-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - proto/worldmonitor/test/v1/service.proto
  - proto/worldmonitor/test/v1/get_test_items.proto
  - proto/worldmonitor/test/v1/test_item.proto
  - src/generated/client/worldmonitor/test/v1/service_client.ts
  - src/generated/server/worldmonitor/test/v1/service_server.ts
  - docs/api/TestService.openapi.json
  - docs/api/TestService.openapi.yaml
  - Makefile
autonomous: true
requirements:
  - PROTO-04
  - PROTO-05

must_haves:
  truths:
    - "Running buf generate produces TypeScript client files in src/generated/client/ with zero errors"
    - "Running buf generate produces TypeScript server handler interfaces in src/generated/server/ with zero errors"
    - "Running buf generate produces OpenAPI v3 specs in docs/api/ in both JSON and YAML formats"
    - "Generated client imports and compiles correctly under the existing tsconfig.json (src/ include path + @/* alias)"
    - "Test domain proto successfully imports shared core types (GeoCoordinates, TimeRange, PaginationRequest/Response)"
    - "buf lint passes on all proto files including the test domain with zero warnings"
    - "Makefile provides generate, lint, clean, and install targets"
  artifacts:
    - path: "src/generated/client/worldmonitor/test/v1/service_client.ts"
      provides: "Generated TypeScript client class for TestService with typed request/response interfaces"
      contains: "class TestServiceClient"
    - path: "src/generated/server/worldmonitor/test/v1/service_server.ts"
      provides: "Generated TypeScript server handler interface and route descriptors for TestService"
      contains: "interface TestServiceHandler"
    - path: "docs/api/TestService.openapi.yaml"
      provides: "OpenAPI 3.1.0 spec in YAML for TestService"
      contains: "openapi:"
    - path: "docs/api/TestService.openapi.json"
      provides: "OpenAPI 3.1.0 spec in JSON for TestService"
      contains: "openapi"
    - path: "Makefile"
      provides: "Build automation with generate, lint, clean, install targets"
      contains: "buf generate"
  key_links:
    - from: "proto/worldmonitor/test/v1/get_test_items.proto"
      to: "proto/worldmonitor/core/v1/geo.proto"
      via: "proto import"
      pattern: "import \"worldmonitor/core/v1/geo.proto\""
    - from: "proto/worldmonitor/test/v1/get_test_items.proto"
      to: "proto/worldmonitor/core/v1/pagination.proto"
      via: "proto import"
      pattern: "import \"worldmonitor/core/v1/pagination.proto\""
    - from: "proto/buf.gen.yaml"
      to: "src/generated/client/"
      via: "protoc-gen-ts-client output"
      pattern: "out: ../src/generated/client"
    - from: "Makefile"
      to: "proto/buf.gen.yaml"
      via: "cd proto && buf generate"
      pattern: "buf generate"
---

<objective>
Create a test domain proto service that imports shared core types, run `buf generate` to produce TypeScript client, server, and OpenAPI output, and set up a Makefile for the generation pipeline.

Purpose: Proves the full code generation pipeline works end-to-end -- proto definitions produce usable TypeScript artifacts and API documentation. The test domain will be replaced by real domains in Phase 3+ but validates every link in the chain now.

Output: Generated TypeScript client class, server handler interface, OpenAPI specs (JSON+YAML), and a Makefile with standard targets.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-proto-foundation/01-CONTEXT.md
@.planning/phases/01-proto-foundation/01-RESEARCH.md
@.planning/phases/01-proto-foundation/01-01-SUMMARY.md

Reference for Makefile patterns:
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/Makefile

Reference for service.proto pattern:
@/Users/sebastienmelki/Documents/documents_sebastiens_mac_mini/Workspace/kompani/anghamna/anghamna/page/v1/service.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test domain proto files with core type imports</name>
  <files>
    proto/worldmonitor/test/v1/service.proto
    proto/worldmonitor/test/v1/get_test_items.proto
    proto/worldmonitor/test/v1/test_item.proto
  </files>
  <action>
Create `proto/worldmonitor/test/v1/` directory with three proto files. This test domain exists solely to validate the code generation pipeline end-to-end. It will be removed or replaced when real domains are added in Phase 3+.

**test_item.proto** -- Domain model:
- `package worldmonitor.test.v1`
- Import `worldmonitor/core/v1/geo.proto`
- Define `TestItem` message with:
  - `string id = 1` (required, min_len=1, max_len=100, example="test_123")
  - `string name = 2` (required, min_len=1, example="Test Item")
  - `string description = 3`
  - `worldmonitor.core.v1.GeoCoordinates location = 4` -- proves core type import works
  - `google.protobuf.Timestamp created_at = 5`
- Import `google/protobuf/timestamp.proto` and `buf/validate/validate.proto`
- Add doc comments on message and every field

**get_test_items.proto** -- Per-RPC file following anghamna pattern:
- `package worldmonitor.test.v1`
- Import core types: `worldmonitor/core/v1/pagination.proto`, `worldmonitor/core/v1/time.proto`
- Import domain model: `worldmonitor/test/v1/test_item.proto`
- Import `buf/validate/validate.proto`
- Define `GetTestItemsRequest` with:
  - `worldmonitor.core.v1.TimeRange time_range = 1` -- proves TimeRange import
  - `worldmonitor.core.v1.PaginationRequest pagination = 2` -- proves Pagination import
- Define `GetTestItemsError` with `string message = 1` (required)
- Define `GetTestItemsResponse` with oneof `response`:
  - `GetTestItemsSuccess success = 1`
  - `GetTestItemsError error = 2`
- Define `GetTestItemsSuccess` with:
  - `repeated TestItem items = 1`
  - `worldmonitor.core.v1.PaginationResponse pagination = 2`
- Add doc comments on every message and field

**service.proto** -- Service definition with HTTP annotations:
- `package worldmonitor.test.v1`
- Import `worldmonitor/test/v1/get_test_items.proto`
- Import `sebuf/http/annotations.proto`
- Define `TestService` with:
  - `option (sebuf.http.service_config) = {base_path: "/api/test/v1"}`
  - RPC `GetTestItems(GetTestItemsRequest) returns (GetTestItemsResponse)` with `option (sebuf.http.config) = {path: "/get-test-items"}`
- Add doc comments on the service and RPC

Run `cd proto && buf lint` to verify all files pass linting including the test domain.
  </action>
  <verify>
Run:
1. `cd proto && buf lint` -- zero errors on all files (core + test)
2. `cd proto && buf build` -- successful compilation
3. `ls proto/worldmonitor/test/v1/*.proto | wc -l` returns 3
4. `grep -c "worldmonitor.core.v1" proto/worldmonitor/test/v1/get_test_items.proto` returns at least 2 (TimeRange + Pagination imports used)
  </verify>
  <done>
Test domain has 3 proto files (service.proto, get_test_items.proto, test_item.proto) that import GeoCoordinates, TimeRange, PaginationRequest/Response from core. `buf lint` passes on all proto files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run buf generate and create Makefile</name>
  <files>
    src/generated/client/worldmonitor/test/v1/service_client.ts
    src/generated/server/worldmonitor/test/v1/service_server.ts
    docs/api/TestService.openapi.json
    docs/api/TestService.openapi.yaml
    Makefile
  </files>
  <action>
**Step 1: Create the Makefile** at the project root (not in `proto/`).

Follow anghamna's Makefile pattern, adapted for WorldMonitor (TypeScript only, no Go/Swift/Java):

```makefile
.PHONY: help lint generate breaking format check clean deps install install-plugins

.DEFAULT_GOAL := help

# Variables
PROTO_DIR := proto
GEN_CLIENT_DIR := src/generated/client
GEN_SERVER_DIR := src/generated/server
DOCS_API_DIR := docs/api

# Go install settings
GO_PROXY := GOPROXY=direct
GO_PRIVATE := GOPRIVATE=github.com/SebastienMelki
GO_INSTALL := $(GO_PROXY) $(GO_PRIVATE) go install

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)

install: install-plugins deps ## Install everything (plugins + dependencies)

install-plugins: ## Install sebuf protoc plugins
	@echo "Installing sebuf protoc plugins..."
	@$(GO_INSTALL) github.com/SebastienMelki/sebuf/cmd/protoc-gen-ts-client@v0.6.0
	@$(GO_INSTALL) github.com/SebastienMelki/sebuf/cmd/protoc-gen-ts-server@v0.6.0
	@$(GO_INSTALL) github.com/SebastienMelki/sebuf/cmd/protoc-gen-openapiv3@v0.6.0
	@echo "Plugins installed!"

deps: ## Install/update buf dependencies
	cd $(PROTO_DIR) && buf dep update

lint: ## Lint protobuf files
	cd $(PROTO_DIR) && buf lint

generate: clean ## Generate code from proto definitions
	@mkdir -p $(GEN_CLIENT_DIR) $(GEN_SERVER_DIR) $(DOCS_API_DIR)
	cd $(PROTO_DIR) && buf generate
	@echo "Code generation complete!"

breaking: ## Check for breaking changes against main
	cd $(PROTO_DIR) && buf breaking --against '.git#branch=main,subdir=proto'

format: ## Format protobuf files
	cd $(PROTO_DIR) && buf format -w

check: lint generate ## Run all checks (lint + generate)

clean: ## Clean generated files
	@rm -rf $(GEN_CLIENT_DIR)
	@rm -rf $(GEN_SERVER_DIR)
	@rm -rf $(DOCS_API_DIR)
	@echo "Clean complete!"
```

**Step 2: Create output directories and run code generation.**

```bash
mkdir -p src/generated/client src/generated/server docs/api
cd proto && buf generate
```

**Step 3: Verify generated output.**

After generation, verify:
- `src/generated/client/worldmonitor/test/v1/service_client.ts` exists and contains `class TestServiceClient`
- `src/generated/server/worldmonitor/test/v1/service_server.ts` exists and contains `interface TestServiceHandler`
- `docs/api/TestService.openapi.yaml` exists and contains `openapi:` header
- `docs/api/TestService.openapi.json` exists and contains `"openapi"` key

**Step 4: Verify TypeScript compilation.**

The generated `.ts` files are under `src/`, which is included by `tsconfig.json`. Run `npx tsc --noEmit` to verify the generated code compiles with the project's strict TypeScript configuration. If strict checks fail on generated code (e.g., `noUnusedLocals`), note this for a follow-up fix but do NOT modify tsconfig.json -- instead, investigate if generated code needs `// @ts-nocheck` or a separate tsconfig for the generated directory.

**Step 5: Run full pipeline via Makefile.**

Run `make check` to verify the entire lint + generate pipeline works through the Makefile.

**Note on protoc-gen-ts-server:** Research confirmed it may not be installed yet. If `buf generate` fails because protoc-gen-ts-server is not found, install it first: `GOPROXY=direct GOPRIVATE=github.com/SebastienMelki go install github.com/SebastienMelki/sebuf/cmd/protoc-gen-ts-server@v0.6.0`. If the v0.6.0 tag does not contain protoc-gen-ts-server (it may be newer), try `@latest`. If it truly does not exist yet, remove the ts-server plugin from buf.gen.yaml temporarily (document this), generate client + OpenAPI only, and note in the SUMMARY that server generation is deferred until the plugin is available.
  </action>
  <verify>
Run:
1. `make generate` -- completes without errors
2. `ls src/generated/client/worldmonitor/test/v1/service_client.ts` -- file exists
3. `grep "class TestServiceClient" src/generated/client/worldmonitor/test/v1/service_client.ts` -- class found
4. `ls src/generated/server/worldmonitor/test/v1/service_server.ts` -- file exists (if ts-server plugin available)
5. `ls docs/api/TestService.openapi.yaml docs/api/TestService.openapi.json` -- both exist
6. `grep "openapi" docs/api/TestService.openapi.yaml` -- OpenAPI version present
7. `npx tsc --noEmit` -- TypeScript compilation passes (or note issues)
8. `make lint` -- passes
9. `make check` -- full pipeline succeeds
  </verify>
  <done>
`buf generate` produces a TypeScript client class (TestServiceClient) in `src/generated/client/`, server handler interface (TestServiceHandler) in `src/generated/server/`, and OpenAPI 3.1.0 specs in both JSON and YAML in `docs/api/`. Makefile provides `generate`, `lint`, `clean`, `install`, `check`, `format`, and `breaking` targets. The generated TypeScript compiles under the project's strict tsconfig. The full `make check` pipeline (lint + generate) succeeds.
  </done>
</task>

</tasks>

<verification>
1. `make check` passes (full lint + generate pipeline)
2. Generated TypeScript client file exists at `src/generated/client/worldmonitor/test/v1/service_client.ts` with `TestServiceClient` class
3. Generated TypeScript server file exists at `src/generated/server/worldmonitor/test/v1/service_server.ts` with `TestServiceHandler` interface (or documented as deferred if plugin unavailable)
4. OpenAPI specs exist at `docs/api/TestService.openapi.yaml` and `docs/api/TestService.openapi.json`
5. Test domain proto imports core types (GeoCoordinates, TimeRange, PaginationRequest/Response) and they appear in generated output
6. `npx tsc --noEmit` compiles the generated code under the project's existing tsconfig
7. `buf lint` passes on ALL proto files (core + test domain) with zero warnings
</verification>

<success_criteria>
- `buf generate` produces TypeScript client, server, and OpenAPI output with zero errors
- Generated client class is importable via `@/generated/client/worldmonitor/test/v1/service_client`
- OpenAPI specs are viewable and correctly describe the test service endpoints
- Makefile automates the full pipeline
- Core types imported by the test domain appear in generated TypeScript interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/01-proto-foundation/01-02-SUMMARY.md`
</output>
